#include <stdlib.h>
#include <conio.h>
#include "galaksija.h"

#define arm_free 			0
#define arm_punch_forward 	1
#define arm_free_up 		2
#define arm_punch_up 		3 	
#define leg_free 			0
#define leg_kick_forward 	1
#define leg_kick_up			2
#define leg_step			3
#define attack_punch_forward 	1
#define attack_punch_up 		2
#define attack_kick_forward 	3
#define attack_kick_up		 	4


char x_pos, y_pos, x_enemy, c, attack;
char sprite[384] = {
  0xc0, 0xc0, 0xc0, 0xef, 0xf7, 0xc1, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xef, 0xf7, 0xc1, 0xc0, 0xc0, 0xc0, 0xc0, 0xca, 0xff, 0xd3, 0xe8, 0xd4, 0xc0, 0xc0, 0xc0, 0xc0, 0xef, 0xf7, 0xc1, 0xc0, 0xf0,
  0xc0, 0xe0, 0xfc, 0xfe, 0xfd, 0xe4, 0xd0, 0xc0, 0xc0, 0xc0, 0xf8, 0xfe, 0xfd, 0xe4, 0xf0, 0xd0, 0xc0, 0xf8, 0xfc, 0xff, 0xdc, 0xdf, 0xc1, 0xc0, 0xc0, 0xc0, 0xf8, 0xfe, 0xfd, 0xe4, 0xfe, 0xc7,
  0xc0, 0xca, 0xff, 0xff, 0xfd, 0xd7, 0xc3, 0xc0, 0xc0, 0xca, 0xff, 0xff, 0xfd, 0xd7, 0xc3, 0xc3, 0xc0, 0xef, 0xff, 0xff, 0xfe, 0xe0, 0xfc, 0xdc, 0xc0, 0xca, 0xff, 0xff, 0xfd, 0xd7, 0xc1, 0xc0,
  0xc0, 0xc0, 0xf8, 0xe3, 0xd3, 0xd0, 0xc0, 0xc0, 0xc0, 0xc0, 0xf8, 0xe3, 0xd3, 0xf0, 0xf0, 0xd0, 0xc0, 0xc0, 0xfa, 0xe3, 0xf1, 0xff, 0xc7, 0xc0, 0xc0, 0xc0, 0xf8, 0xe3, 0xd3, 0xd0, 0xc0, 0xc0,
  0xc0, 0xe8, 0xff, 0xdf, 0xff, 0xfd, 0xc0, 0xc0, 0xc0, 0xe8, 0xff, 0xdf, 0xcf, 0xcf, 0xcf, 0xcf, 0xc0, 0xf8, 0xff, 0xcf, 0xc7, 0xc1, 0xc0, 0xc0, 0xc0, 0xf8, 0xff, 0xcf, 0xef, 0xfd, 0xd0, 0xc0,
  0xc0, 0xfe, 0xff, 0xc0, 0xea, 0xff, 0xd4, 0xc0, 0xc0, 0xfe, 0xff, 0xc1, 0xc0, 0xc0, 0xc0, 0xc0, 0xfa, 0xff, 0xc7, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xfa, 0xff, 0xc7, 0xc0, 0xc0, 0xcb, 0xff, 0xf4,
  0xc0, 0xc0, 0xc2, 0xfb, 0xdf, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc2, 0xfb, 0xdf, 0xc0, 0xc0, 0xc0, 0xc0, 0xe8, 0xd4, 0xe3, 0xff, 0xc5, 0xc0, 0xc0, 0xf0, 0xc0, 0xc2, 0xfb, 0xdf, 0xc0, 0xc0, 0xc0,
  0xc0, 0xe0, 0xd8, 0xfe, 0xfd, 0xfc, 0xd0, 0xc0, 0xe0, 0xf0, 0xd8, 0xfe, 0xfd, 0xf4, 0xc0, 0xc0, 0xc0, 0xc2, 0xef, 0xec, 0xff, 0xfc, 0xf4, 0xc0, 0xcb, 0xfd, 0xd8, 0xfe, 0xfd, 0xf4, 0xc0, 0xc0,
  0xc0, 0xc3, 0xeb, 0xfe, 0xff, 0xff, 0xc5, 0xc0, 0xc3, 0xc3, 0xeb, 0xfe, 0xff, 0xff, 0xc5, 0xc0, 0xec, 0xfc, 0xd0, 0xfd, 0xff, 0xff, 0xdf, 0xc0, 0xc0, 0xc2, 0xeb, 0xfe, 0xff, 0xff, 0xc5, 0xc0,
  0xc0, 0xc0, 0xe0, 0xe3, 0xd3, 0xf4, 0xc0, 0xc0, 0xe0, 0xf0, 0xf0, 0xe3, 0xd3, 0xf4, 0xc0, 0xc0, 0xc0, 0xcb, 0xff, 0xf2, 0xd3, 0xf5, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xe3, 0xd3, 0xf4, 0xc0, 0xc0,
  0xc0, 0xc0, 0xfe, 0xff, 0xef, 0xff, 0xd4, 0xc0, 0xcf, 0xcf, 0xcf, 0xcf, 0xef, 0xff, 0xd4, 0xc0, 0xc0, 0xc0, 0xc2, 0xcb, 0xcf, 0xff, 0xf4, 0xc0, 0xc0, 0xe0, 0xfe, 0xdf, 0xcf, 0xff, 0xf4, 0xc0,
  0xc0, 0xe8, 0xff, 0xd5, 0xc0, 0xff, 0xfd, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc2, 0xff, 0xfd, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xcb, 0xff, 0xf5, 0xf8, 0xff, 0xc7, 0xc0, 0xc0, 0xcb, 0xff, 0xf5,
};
char bg[96] = {
  0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xc6, 0xef, 0xdc, 0xd0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc2, 0xef, 0xdf, 0xc1,
  0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xcc, 0xc1, 0xc0, 0xc0, 0xcb, 0xc6, 0xcc, 0xd0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
  0xcc, 0xc3, 0xcc, 0xcc, 0xcc, 0xc6, 0xc9, 0xcc, 0xcc, 0xcc, 0xc3, 0xcc, 0xcc, 0xcc, 0xc3, 0xcc, 0xcc, 0xcc, 0xc6, 0xc9, 0xcc, 0xcc, 0xcc, 0xc3, 0xcc, 0xcc, 0xcc, 0xc6, 0xc9, 0xcc, 0xcc, 0xcc
};
char hits[2];
int rnd;
char nstr[10];

/*
	draw background
*/
void draw_bg () {
	for (char i = 0; i < 32; i++) {
		z80_bpoke(SCREEN_ADDR + (13 << 5) + i, 143);
	}
	for (char i = 0; i < 96; i++) {
		z80_bpoke(SCREEN_ADDR + i, bg[i]);
	}
}

/*
	draw hits
*/
void draw_hits () {
	gal_gotoxy(6,14); gal_puts("YOU");
	gal_gotoxy(22,14); gal_puts("ENEMY");
	for (char i = 0; i < 11; i++) {
		z80_bpoke(SCREEN_ADDR + (15 << 5) + i + 2, 32);
		if (i < hits[0]) {
			z80_bpoke(SCREEN_ADDR + (15 << 5) + i + 2, 255);
		}
		z80_bpoke(SCREEN_ADDR + (15 << 5) + i + 19, 32);
		if (i < hits[1]) {
			z80_bpoke(SCREEN_ADDR + (15 << 5) + i + 19, 255);
		}
	}
}

/*
	draw sprite
	character: 0 - you, 1 - enemy
	xp: x position
	arm: 0 - free, 1 - punch forward, 2 - free up, 3 - punch up	
	leg: 0 - free, 1 - kick forward, 2 - kick up, 3 - step
*/
void draw_sprite (char character, char xp, char arm, char leg) {
	char p0 = arm<<3;
	char p1 = leg<<3;	
	int addr0 = SCREEN_ADDR + (y_pos << 5) + xp;
	for (char j = 0; j < 6; j++) {
		if (arm != leg && j == 3) {
			p0 = p1;
		}
		for (char i = 0; i < 8; i++) {
			z80_bpoke(addr0 + (j << 5) + i, sprite[p0 + (j << 5) + i + (character * 192)]);
		}
	}
}

int main() {
	rnd = z80_wpeek(RND_ADDR);
	srand(rnd);
	gal_cls();
	draw_bg ();
	attack = 0;
	x_pos = 0;
	x_enemy = 23;
 	y_pos = 7;
	hits[0] = 11;
	hits[1] = 11;
	draw_sprite(0, x_pos, 0, 0);
	draw_sprite(1, x_enemy, 0, 0);
	draw_hits();
	do {
		c = getk();
		switch (c) {
			case 45: // left 
				attack = 0;
				x_pos--;
				draw_sprite(0, x_pos, arm_free, leg_step);
				draw_sprite(0, x_pos, arm_free, leg_free);
				break;
			case 46: // right
				attack = 0;
				x_pos++;
				draw_sprite(0, x_pos, arm_free, leg_step);
				draw_sprite(0, x_pos, arm_free, leg_free);
				break;
			case 43: // up, kick up
				attack = attack_kick_up;
				draw_sprite(0, x_pos, arm_free_up, leg_kick_up);
				break;
			case 44: // down, kick forward
				attack = attack_kick_forward;
				draw_sprite(0, x_pos, arm_free, leg_kick_forward);
				break;
			case 'Q': // punch up
				attack = attack_punch_up;
				draw_sprite(0, x_pos, arm_punch_up, leg_free);
				break;				
			case 'A': // punch forward
				attack = attack_punch_forward;
				draw_sprite(0, x_pos, arm_punch_forward, leg_free);
				break;				
			case 0:
				if (attack > 0) {
					attack = 0;
					draw_sprite(0, x_pos, arm_free, leg_free);
				}
				break;
			default:
				break;
		}
	} while (c != 67);

	return 0;
}
